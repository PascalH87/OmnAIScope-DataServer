<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3658px" preserveAspectRatio="none" style="width:2539px;height:3658px;" version="1.1" viewBox="0 0 2539 3658" width="2539px" zoomAndPan="magnify"><defs><filter height="300%" id="fyjuvjg04b1x8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="562" x="984" y="29.2419">OmnAIScope DataServer - WS + SaveDeque + Recording/Save Flow</text><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="1113.9321" style="stroke: #000000; stroke-width: 2.0;" width="2428" x="13" y="498.6439"/><rect fill="#FFFFFF" height="1062.5201" style="stroke: none; stroke-width: 1.0;" width="2428" x="13" y="550.056"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="760.184" style="stroke: #000000; stroke-width: 2.0;" width="2408" x="23" y="845.392"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="694.772" style="stroke: #000000; stroke-width: 2.0;" width="2388" x="33" y="903.804"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="69.118" style="stroke: #000000; stroke-width: 2.0;" width="928" x="864" y="1075.0401"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="339.0239" style="stroke: #000000; stroke-width: 2.0;" width="2368" x="43" y="1203.8642"/><rect fill="#FFFFFF" height="112.0999" style="stroke: none; stroke-width: 1.0;" width="2368" x="43" y="1318.6883"/><rect fill="#FFFFFF" height="112.0999" style="stroke: none; stroke-width: 1.0;" width="2368" x="43" y="1430.7882"/><rect fill="#FFFFFF" height="48.6879" style="stroke: none; stroke-width: 1.0;" width="2388" x="33" y="1549.8881"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="389.1601" style="stroke: #000000; stroke-width: 2.0;" width="2474" x="43" y="1780.4001"/><rect fill="#FFFFFF" height="337.7481" style="stroke: none; stroke-width: 1.0;" width="2474" x="43" y="1831.8121"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="116.8241" style="stroke: #000000; stroke-width: 2.0;" width="1057" x="1450" y="2045.7361"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="83.118" style="stroke: #000000; stroke-width: 2.0;" width="1037" x="1460" y="2072.4422"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="226.63" style="stroke: #000000; stroke-width: 2.0;" width="1441" x="43" y="2337.3843"/><rect fill="#FFFFFF" height="175.218" style="stroke: none; stroke-width: 1.0;" width="1441" x="43" y="2388.7963"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="292.336" style="stroke: #000000; stroke-width: 2.0;" width="2464" x="43" y="2731.8384"/><rect fill="#FFFFFF" height="240.924" style="stroke: none; stroke-width: 1.0;" width="2464" x="43" y="2783.2504"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="83.118" style="stroke: #000000; stroke-width: 2.0;" width="1037" x="1460" y="2870.6443"/><rect fill="#FFFFFF" filter="url(#fyjuvjg04b1x8)" height="205.218" style="stroke: #000000; stroke-width: 2.0;" width="1913" x="43" y="3191.9985"/><rect fill="#FFFFFF" height="153.806" style="stroke: none; stroke-width: 1.0;" width="1913" x="43" y="3243.4105"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="468.5" x2="468.5" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="661.5" x2="661.5" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="948" x2="948" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1174.5" x2="1174.5" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1375" x2="1375" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1571" x2="1571" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1732" x2="1732" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1869" x2="1869" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2051" x2="2051" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2212" x2="2212" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2340" x2="2340" y1="127.5838" y2="3646.1586"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2449" x2="2449" y1="127.5838" y2="3646.1586"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="53" y="123.4818">Client</text><ellipse cx="75.5" cy="51.5158" fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75.5,59.5158 L75.5,86.5158 M62.5,67.5158 L88.5,67.5158 M75.5,86.5158 L62.5,101.5158 M75.5,86.5158 L88.5,101.5158 " fill="none" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="52.1358" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="406.5" y="70.4479"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="413.5" y="92.4139">Crow WS Server</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="451" y="111.4818">(/ws)</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="52.1358" style="stroke: #A80036; stroke-width: 1.5;" width="150" x="584.5" y="70.4479"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="620" y="92.4139">CmdWorker</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="136" x="591.5" y="111.4818">(workOnCommands)</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="894" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="901" y="111.4818">ControlWriter</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="108" x="1118.5" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="94" x="1125.5" y="111.4818">Measurement</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="125" x="1311" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="111" x="1318" y="111.4818">QueueFormatter</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="52.1358" style="stroke: #A80036; stroke-width: 1.5;" width="154" x="1494" y="66.4479"/><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="52.1358" style="stroke: #A80036; stroke-width: 1.5;" width="154" x="1490" y="70.4479"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="75" x="1529.5" y="92.4139">SaveDeque</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="140" x="1497" y="111.4818">(full-rate ring buffer)</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="1702" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="1709" y="111.4818">Writer</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="52.1358" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="1812" y="70.4479"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="1819" y="92.4139">processDeque</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="1839.5" y="111.4818">(sender)</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="146" x="1976" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="1983" y="111.4818">OmniscopeSampler</text><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="2180" y="85.5158"/><rect fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" height="33.0679" style="stroke: #A80036; stroke-width: 1.5;" width="65" x="2176" y="89.5158"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="51" x="2183" y="111.4818">Devices</text><path d="M2284,79.4479 L2396,79.4479 C2401,79.4479 2401,103.5158 2401,103.5158 C2401,103.5158 2401,127.5838 2396,127.5838 L2284,127.5838 C2279,127.5838 2279,103.5158 2279,103.5158 C2279,103.5158 2279,79.4479 2284,79.4479 " fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M2396,79.4479 C2391,79.4479 2391,103.5158 2391,103.5158 C2391,127.5838 2396,127.5838 2396,127.5838 " fill="none" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="77" x="2296.5" y="99.4139">WS Queues</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="2284" y="118.4818">(JSON/CSV/BIN)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="2411" y="123.4818">Filesystem</text><path d="M2431,72.5158 C2431,62.5158 2449,62.5158 2449,62.5158 C2449,62.5158 2467,62.5158 2467,72.5158 L2467,98.5158 C2467,108.5158 2449,108.5158 2449,108.5158 C2449,108.5158 2431,108.5158 2431,98.5158 L2431,72.5158 " fill="#FEFECE" filter="url(#fyjuvjg04b1x8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M2431,72.5158 C2431,82.5158 2449,82.5158 2449,82.5158 C2449,82.5158 2467,82.5158 2467,72.5158 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="159.4368"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="159.4368" y2="159.4368"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="162.4368" y2="162.4368"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="166" x="1182" y="147.5838"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="1188" y="165.4808">WebSocket handshake</text><polygon fill="#555555" points="456.5,202.9958,466.5,206.9958,456.5,210.9958,460.5,206.9958" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="206.9958" y2="206.9958"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="243.5" y="201.1868">Open /ws</text><polygon fill="#555555" points="86.5,234.7018,76.5,238.7018,86.5,242.7018,82.5,238.7018" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="467.5" y1="238.7018" y2="238.7018"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="133.5" y="232.8928">"Hello, connection to websocket established..."</text><path d="M473,251.7018 L473,296.7018 L701,296.7018 L701,261.7018 L691,251.7018 L473,251.7018 " fill="#F8F8F8" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M691,251.7018 L691,261.7018 L701,261.7018 L691,251.7018 " fill="#F8F8F8" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="479" y="270.5988">websocketConnectionActive = true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="479" y="288.3048">start cmdWorker (std::jthread)</text><polygon fill="#555555" points="649.5,325.8199,659.5,329.8199,649.5,333.8199,653.5,329.8199" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="329.8199" y2="329.8199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="547" y="324.0109">start()</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="359.6729"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="359.6729" y2="359.6729"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="362.6729" y2="362.6729"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="155" x="1187.5" y="347.8199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="1193.5" y="365.7169">START measurement</text><polygon fill="#555555" points="456.5,403.2319,466.5,407.2319,456.5,411.2319,460.5,407.2319" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="407.2319" y2="407.2319"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="87.5" y="401.4229">{"type":"start","uuids":[...],"rate":int,"format":"csv/json/binary"}</text><polygon fill="#555555" points="649.5,434.9379,659.5,438.9379,649.5,442.9379,653.5,438.9379" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="438.9379" y2="438.9379"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="503" y="433.1289">enqueue(Command)</text><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="703.5" y1="470.6439" y2="470.6439"/><line style="stroke: #555555; stroke-width: 1.0;" x1="703.5" x2="703.5" y1="470.6439" y2="483.6439"/><line style="stroke: #555555; stroke-width: 1.0;" x1="662.5" x2="703.5" y1="483.6439" y2="483.6439"/><polygon fill="#555555" points="672.5,479.6439,662.5,483.6439,672.5,487.6439,668.5,483.6439" style="stroke: #555555; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="668.5" y="464.8349">parseCommand("start")</text><path d="M13,498.6439 L76,498.6439 L76,507.6439 L66,517.6439 L13,517.6439 L13,498.6439 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1113.9321" style="stroke: #000000; stroke-width: 2.0;" width="2428" x="13" y="498.6439"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="28" y="513.5409">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="91" y="512.4028">[already running (wsCtx.currentMeasurement != null)]</text><polygon fill="#555555" points="86.5,538.056,76.5,542.056,86.5,546.056,82.5,542.056" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="542.056" y2="542.056"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="250" y="536.247">{"type":"error","msg":"already running"}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="13" x2="2441" y1="551.056" y2="551.056"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="18" y="562.8149">[start new measurement]</text><polygon fill="#555555" points="479.5,586.7439,469.5,590.7439,479.5,594.7439,475.5,590.7439" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="473.5" x2="660.5" y1="590.7439" y2="590.7439"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="517" y="584.9349">clearAllQueues()</text><polygon fill="#555555" points="1162.5,618.4499,1172.5,622.4499,1162.5,626.4499,1166.5,622.4499" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="1168.5" y1="622.4499" y2="622.4499"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="768" y="616.6409">create Measurement(uuids, rate, format, dest=WS)</text><polygon fill="#555555" points="1857,650.1559,1867,654.1559,1857,658.1559,1861,654.1559" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="1863" y1="654.1559" y2="654.1559"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1143.25" y="648.3469">start processDeque(conn, Measurement)</text><polygon fill="#555555" points="1162.5,681.8619,1172.5,685.8619,1162.5,689.8619,1166.5,685.8619" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="1168.5" y1="685.8619" y2="685.8619"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="789.5" y="680.0529">start Measurement::start(Ctrl) (std::jthread)</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="715.7149"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="715.7149" y2="715.7149"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="718.7149" y2="718.7149"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="150" x="1190" y="703.8619"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="1196" y="721.7589">Measurement::start</text><polygon fill="#555555" points="2200.5,794.686,2210.5,798.686,2200.5,802.686,2204.5,798.686" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1174.5" x2="2206.5" y1="798.686" y2="798.686"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="1647.5" y="757.4649">searchDevices()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1633.5" y="775.171">selectDevices(uuids)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1655.5" y="792.877">Start devices</text><polygon fill="#555555" points="2039,826.392,2049,830.392,2039,834.392,2043,830.392" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1174.5" x2="2045" y1="830.392" y2="830.392"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="1503.25" y="824.583">set up sampler and begin acquisition</text><path d="M23,845.392 L96,845.392 L96,854.392 L86,864.392 L23,864.392 L23,845.392 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="760.184" style="stroke: #000000; stroke-width: 2.0;" width="2408" x="23" y="845.392"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="38" y="860.289">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="111" y="859.1509">[while not stop_requested]</text><polygon fill="#555555" points="959.5,884.804,949.5,888.804,959.5,892.804,955.5,888.804" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="953.5" x2="1173.5" y1="888.804" y2="888.804"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="960.5" y="882.995">printOrWriteData(self, stopToken)</text><path d="M33,903.804 L96,903.804 L96,912.804 L86,922.804 L33,922.804 L33,903.804 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="694.772" style="stroke: #000000; stroke-width: 2.0;" width="2388" x="33" y="903.804"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="48" y="918.701">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="111" y="917.5629">[sampler has data]</text><polygon fill="#555555" points="2039,943.2161,2049,947.2161,2039,951.2161,2043,947.2161" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="948.5" x2="2045" y1="947.2161" y2="947.2161"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="1342.75" y="941.4071">copyOut(captureData) (until vectorSize &gt;= threshold)</text><polygon fill="#555555" points="1363.5,974.9221,1373.5,978.9221,1363.5,982.9221,1367.5,978.9221" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="948.5" x2="1369.5" y1="978.9221" y2="978.9221"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="403" x="960.5" y="973.1131">new QueueFormatter(captureData, sampleQueue, SaveDeque, rate)</text><polygon fill="#555555" points="1559,1024.3341,1569,1028.3341,1559,1032.3341,1563,1028.3341" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1375.5" x2="1565" y1="1028.3341" y2="1028.3341"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1405.25" y="1004.8191">push(full-rate samples)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1419.25" y="1022.5251">(drop oldest if full)</text><polygon fill="#555555" points="959.5,1056.0401,949.5,1060.0401,959.5,1064.0401,955.5,1060.0401" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="953.5" x2="1374.5" y1="1060.0401" y2="1060.0401"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="1075.5" y="1054.2311">sampled queue filled per rate</text><path d="M864,1075.0401 L927,1075.0401 L927,1084.0401 L917,1094.0401 L864,1094.0401 L864,1075.0401 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="69.118" style="stroke: #000000; stroke-width: 2.0;" width="928" x="864" y="1075.0401"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="879" y="1089.9371">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="942" y="1088.799">[Writer not created yet]</text><polygon fill="#555555" points="1720,1132.1582,1730,1136.1582,1720,1140.1582,1724,1136.1582" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="948.5" x2="1726" y1="1136.1582" y2="1136.1582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1173.25" y="1112.6432">new Writer(measurement, sampleQueue, SaveDeque, ...)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="1286.75" y="1130.3492">(dest=WS, format)</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="1173.0112"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="1173.0112" y2="1173.0112"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="1176.0112" y2="1176.0112"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="130" x="1200" y="1161.1582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="113" x="1206" y="1179.0552">streaming via WS</text><path d="M43,1203.8642 L106,1203.8642 L106,1212.8642 L96,1222.8642 L43,1222.8642 L43,1203.8642 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="339.0239" style="stroke: #000000; stroke-width: 2.0;" width="2368" x="43" y="1203.8642"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="1218.7612">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="121" y="1217.6231">[format == JSON]</text><polygon fill="#555555" points="2328,1243.2762,2338,1247.2762,2328,1251.2762,2332,1247.2762" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1732" x2="2334" y1="1247.2762" y2="1247.2762"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="1985.5" y="1241.4672">push JSON batch</text><polygon fill="#555555" points="2328,1274.9822,2338,1278.9822,2328,1282.9822,2332,1278.9822" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1869" x2="2334" y1="1278.9822" y2="1278.9822"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="2092.5" y="1273.1732">pop</text><polygon fill="#555555" points="86.5,1306.6883,76.5,1310.6883,86.5,1314.6883,82.5,1310.6883" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="1868" y1="1310.6883" y2="1310.6883"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="921.25" y="1304.8793">{"type":"data", ...}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="2411" y1="1319.6883" y2="1319.6883"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="48" y="1331.4472">[format == CSV]</text><polygon fill="#555555" points="2328,1355.3762,2338,1359.3762,2328,1363.3762,2332,1359.3762" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1732" x2="2334" y1="1359.3762" y2="1359.3762"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1989.5" y="1353.5672">push CSV batch</text><polygon fill="#555555" points="2328,1387.0822,2338,1391.0822,2328,1395.0822,2332,1391.0822" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1869" x2="2334" y1="1391.0822" y2="1391.0822"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="2092.5" y="1385.2732">pop</text><polygon fill="#555555" points="86.5,1418.7882,76.5,1422.7882,86.5,1426.7882,82.5,1422.7882" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="1868" y1="1422.7882" y2="1422.7882"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="945.75" y="1416.9792">CSV lines</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="2411" y1="1431.7882" y2="1431.7882"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="48" y="1443.5471">[format == BINARY]</text><polygon fill="#555555" points="2328,1467.4761,2338,1471.4761,2328,1475.4761,2332,1471.4761" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1732" x2="2334" y1="1471.4761" y2="1471.4761"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1974" y="1465.6671">push Protobuf batch</text><polygon fill="#555555" points="2328,1499.1821,2338,1503.1821,2328,1507.1821,2332,1503.1821" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1869" x2="2334" y1="1503.1821" y2="1503.1821"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="2092.5" y="1497.3731">pop</text><polygon fill="#555555" points="86.5,1530.8881,76.5,1534.8881,86.5,1538.8881,82.5,1534.8881" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="1868" y1="1534.8881" y2="1534.8881"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="934.25" y="1529.0791">binary frame</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="2421" y1="1550.8881" y2="1550.8881"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="51" x="38" y="1562.647">[no data]</text><polygon fill="#555555" points="1162.5,1586.576,1172.5,1590.576,1162.5,1594.576,1166.5,1590.576" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="948.5" x2="1168.5" y1="1590.576" y2="1590.576"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="992.5" y="1584.767">return (loop continues)</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="1641.4291"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="1641.4291" y2="1641.4291"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="1644.4291" y2="1644.4291"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="105" x="1212.5" y="1629.576"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="1218.5" y="1647.4731">RECORD start</text><polygon fill="#555555" points="456.5,1684.9881,466.5,1688.9881,456.5,1692.9881,460.5,1688.9881" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="1688.9881" y2="1688.9881"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="128.5" y="1683.1791">{"type":"record","set":"start","format":"csv/json"}</text><polygon fill="#555555" points="649.5,1716.6941,659.5,1720.6941,649.5,1724.6941,653.5,1720.6941" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="1720.6941" y2="1720.6941"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="503" y="1714.8851">enqueue(Command)</text><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="703.5" y1="1752.4001" y2="1752.4001"/><line style="stroke: #555555; stroke-width: 1.0;" x1="703.5" x2="703.5" y1="1752.4001" y2="1765.4001"/><line style="stroke: #555555; stroke-width: 1.0;" x1="662.5" x2="703.5" y1="1765.4001" y2="1765.4001"/><polygon fill="#555555" points="672.5,1761.4001,662.5,1765.4001,672.5,1769.4001,668.5,1765.4001" style="stroke: #555555; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="668.5" y="1746.5911">parseCommand("record:start")</text><path d="M43,1780.4001 L106,1780.4001 L106,1789.4001 L96,1799.4001 L43,1799.4001 L43,1780.4001 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="389.1601" style="stroke: #000000; stroke-width: 2.0;" width="2474" x="43" y="1780.4001"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="1795.2971">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="121" y="1794.159">[already recording (RECORDING == true)]</text><polygon fill="#555555" points="86.5,1819.8121,76.5,1823.8121,86.5,1827.8121,82.5,1823.8121" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="1823.8121" y2="1823.8121"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="239.5" y="1818.0031">{"type":"record","status":"already-running"}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="2517" y1="1832.8121" y2="1832.8121"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="48" y="1844.5711">[begin recording to tmp]</text><polygon fill="#555555" points="936.5,1868.5,946.5,1872.5,936.5,1876.5,940.5,1872.5" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="942.5" y1="1872.5" y2="1872.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="750.5" y="1866.691">startRecording(m)</text><path d="M953,1885.5 L953,1965.5 L1299,1965.5 L1299,1895.5 L1289,1885.5 L953,1885.5 " fill="#F8F8F8" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1289,1885.5 L1289,1895.5 L1299,1895.5 L1289,1885.5 " fill="#F8F8F8" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="959" y="1904.3971">ensureRecordTmpPath():</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="959" y="1922.1031">- create dir "Record" (idempotent)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="959" y="1939.8091">- tmp file: "Record/&lt;timestamp&gt;.tmp"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="959" y="1957.5151">m.dest=LOCALFILE, m.filePath=.tmp, RECORDING=true</text><polygon fill="#555555" points="1720,1995.0301,1730,1999.0301,1720,2003.0301,1724,1999.0301" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="948.5" x2="1726" y1="1999.0301" y2="1999.0301"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="1180.75" y="1993.2211">new Writer(m, SaveDequeâ†’File, recordingMode=true)</text><polygon fill="#555555" points="86.5,2026.7361,76.5,2030.7361,86.5,2034.7361,82.5,2030.7361" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="947.5" y1="2030.7361" y2="2030.7361"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="409.5" y="2024.9271">{"type":"record","status":"started"}</text><path d="M1450,2045.7361 L1646,2045.7361 L1646,2054.7361 L1636,2064.7361 L1450,2064.7361 L1450,2045.7361 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="116.8241" style="stroke: #000000; stroke-width: 2.0;" width="1057" x="1450" y="2045.7361"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="1465" y="2060.6332">Writer(recordingMode)</text><path d="M1460,2072.4422 L1533,2072.4422 L1533,2081.4422 L1523,2091.4422 L1460,2091.4422 L1460,2072.4422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="83.118" style="stroke: #000000; stroke-width: 2.0;" width="1037" x="1460" y="2072.4422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="1475" y="2087.3392">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1548" y="2086.2011">[while running AND RECORDING]</text><polygon fill="#555555" points="1582,2111.8542,1572,2115.8542,1582,2119.8542,1578,2115.8542" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1576" x2="1731" y1="2115.8542" y2="2115.8542"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1619.5" y="2110.0452">pop oldest</text><polygon fill="#555555" points="2437,2143.5602,2447,2147.5602,2437,2151.5602,2441,2147.5602" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1732" x2="2443" y1="2147.5602" y2="2147.5602"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="1969.5" y="2141.7512">append to "&lt;timestamp&gt;.tmp" (csv/json)</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="2198.4132"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="2198.4132" y2="2198.4132"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="2201.4132" y2="2201.4132"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="101" x="1214.5" y="2186.5602"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="1220.5" y="2204.4572">RECORD stop</text><polygon fill="#555555" points="456.5,2241.9722,466.5,2245.9722,456.5,2249.9722,460.5,2245.9722" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="2245.9722" y2="2245.9722"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="187" y="2240.1632">{"type":"record","set":"stop"}</text><polygon fill="#555555" points="649.5,2273.6783,659.5,2277.6783,649.5,2281.6783,653.5,2277.6783" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="2277.6783" y2="2277.6783"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="503" y="2271.8693">enqueue(Command)</text><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="703.5" y1="2309.3843" y2="2309.3843"/><line style="stroke: #555555; stroke-width: 1.0;" x1="703.5" x2="703.5" y1="2309.3843" y2="2322.3843"/><line style="stroke: #555555; stroke-width: 1.0;" x1="662.5" x2="703.5" y1="2322.3843" y2="2322.3843"/><polygon fill="#555555" points="672.5,2318.3843,662.5,2322.3843,672.5,2326.3843,668.5,2322.3843" style="stroke: #555555; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="668.5" y="2303.5753">parseCommand("record:stop")</text><path d="M43,2337.3843 L106,2337.3843 L106,2346.3843 L96,2356.3843 L43,2356.3843 L43,2337.3843 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="226.63" style="stroke: #000000; stroke-width: 2.0;" width="1441" x="43" y="2337.3843"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="2352.2813">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="121" y="2351.1432">[not recording]</text><polygon fill="#555555" points="86.5,2376.7963,76.5,2380.7963,86.5,2384.7963,82.5,2380.7963" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="2380.7963" y2="2380.7963"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="251" y="2374.9873">{"type":"record","status":"not-running"}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="1484" y1="2389.7963" y2="2389.7963"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="48" y="2401.5552">[stop and finalize]</text><polygon fill="#555555" points="936.5,2425.4842,946.5,2429.4842,936.5,2433.4842,940.5,2429.4842" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="942.5" y1="2429.4842" y2="2429.4842"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="742" y="2423.6752">stopRecording(conn)</text><path d="M953,2442.4842 L953,2522.4842 L1470,2522.4842 L1470,2452.4842 L1460,2442.4842 L953,2442.4842 " fill="#F8F8F8" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1460,2442.4842 L1460,2452.4842 L1470,2452.4842 L1460,2442.4842 " fill="#F8F8F8" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="959" y="2461.3812">RECORDING=false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="959" y="2479.0872">delete Writer (waits for thread to finish)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="959" y="2496.7933">rename "&lt;timestamp&gt;.tmp" -&gt; "&lt;timestamp&gt;.(csv/json)"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="959" y="2514.4993">send {"type":"file-ready","url":"/download/Record/&lt;timestamp&gt;.(csv/json)"} to client</text><polygon fill="#555555" points="86.5,2552.0143,76.5,2556.0143,86.5,2560.0143,82.5,2556.0143" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="2556.0143" y2="2556.0143"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="260.5" y="2550.2053">{"type":"record","status":"stopping"}</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="2592.8673"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="2592.8673" y2="2592.8673"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="2595.8673" y2="2595.8673"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="172" x="1179" y="2581.0143"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="1185" y="2598.9113">SAVE (export full buffer)</text><polygon fill="#555555" points="456.5,2636.4263,466.5,2640.4263,456.5,2644.4263,460.5,2640.4263" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="2640.4263" y2="2640.4263"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="103.5" y="2634.6173">{"type":"save","path":"Data.csv/json","format":"csv/json"}</text><polygon fill="#555555" points="649.5,2668.1323,659.5,2672.1323,649.5,2676.1323,653.5,2672.1323" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="2672.1323" y2="2672.1323"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="503" y="2666.3233">enqueue(Command)</text><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="703.5" y1="2703.8384" y2="2703.8384"/><line style="stroke: #555555; stroke-width: 1.0;" x1="703.5" x2="703.5" y1="2703.8384" y2="2716.8384"/><line style="stroke: #555555; stroke-width: 1.0;" x1="662.5" x2="703.5" y1="2716.8384" y2="2716.8384"/><polygon fill="#555555" points="672.5,2712.8384,662.5,2716.8384,672.5,2720.8384,668.5,2716.8384" style="stroke: #555555; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="668.5" y="2698.0294">parseCommand("save")</text><path d="M43,2731.8384 L106,2731.8384 L106,2740.8384 L96,2750.8384 L43,2750.8384 L43,2731.8384 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="292.336" style="stroke: #000000; stroke-width: 2.0;" width="2464" x="43" y="2731.8384"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="2746.7354">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="121" y="2745.5973">[measurement running]</text><polygon fill="#555555" points="86.5,2771.2504,76.5,2775.2504,86.5,2779.2504,82.5,2775.2504" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="2775.2504" y2="2775.2504"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="198" y="2769.4414">{"type":"error","msg":"Stop measurement before saving"}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="2507" y1="2784.2504" y2="2784.2504"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="48" y="2796.0093">[write entire SaveDeque to file]</text><polygon fill="#555555" points="936.5,2819.9383,946.5,2823.9383,936.5,2827.9383,940.5,2823.9383" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="942.5" y1="2823.9383" y2="2823.9383"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="755.5" y="2818.1293">saveData(wsCtx)</text><polygon fill="#555555" points="1720,2851.6443,1730,2855.6443,1720,2859.6443,1724,2855.6443" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="948.5" x2="1726" y1="2855.6443" y2="2855.6443"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1173.25" y="2849.8353">new Writer(m dest=LOCALFILE, filePath="Data.csv/json")</text><path d="M1460,2870.6443 L1533,2870.6443 L1533,2879.6443 L1523,2889.6443 L1460,2889.6443 L1460,2870.6443 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="83.118" style="stroke: #000000; stroke-width: 2.0;" width="1037" x="1460" y="2870.6443"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="1475" y="2885.5413">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="1548" y="2884.4032">[until SaveDeque empty]</text><polygon fill="#555555" points="1582,2910.0564,1572,2914.0564,1582,2918.0564,1578,2914.0564" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1576" x2="1731" y1="2914.0564" y2="2914.0564"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1619.5" y="2908.2473">pop oldest</text><polygon fill="#555555" points="2437,2941.7624,2447,2945.7624,2437,2949.7624,2441,2945.7624" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="1732" x2="2443" y1="2945.7624" y2="2945.7624"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="2013" y="2939.9534">append to "Data.csv/json"</text><polygon fill="#555555" points="936.5,2980.4684,946.5,2984.4684,936.5,2988.4684,940.5,2984.4684" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="942.5" y1="2984.4684" y2="2984.4684"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="722" y="2978.6594">stopWriter()  # delete Writer</text><polygon fill="#555555" points="86.5,3012.1744,76.5,3016.1744,86.5,3020.1744,82.5,3016.1744" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="3016.1744" y2="3016.1744"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="215" y="3010.3654">{"type":"file-ready","url":"/download/Data.csv/json"}</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="3053.0274"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="3053.0274" y2="3053.0274"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="3056.0274" y2="3056.0274"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="147" x="1191.5" y="3041.1744"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="130" x="1197.5" y="3059.0714">STOP measurement</text><polygon fill="#555555" points="456.5,3096.5864,466.5,3100.5864,456.5,3104.5864,460.5,3100.5864" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="3100.5864" y2="3100.5864"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="228.5" y="3094.7774">{"type":"stop"}</text><polygon fill="#555555" points="649.5,3128.2924,659.5,3132.2924,649.5,3136.2924,653.5,3132.2924" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="3132.2924" y2="3132.2924"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="503" y="3126.4834">enqueue(Command)</text><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="703.5" y1="3163.9985" y2="3163.9985"/><line style="stroke: #555555; stroke-width: 1.0;" x1="703.5" x2="703.5" y1="3163.9985" y2="3176.9985"/><line style="stroke: #555555; stroke-width: 1.0;" x1="662.5" x2="703.5" y1="3176.9985" y2="3176.9985"/><polygon fill="#555555" points="672.5,3172.9985,662.5,3176.9985,672.5,3180.9985,668.5,3176.9985" style="stroke: #555555; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="668.5" y="3158.1895">parseCommand("stop")</text><path d="M43,3191.9985 L106,3191.9985 L106,3200.9985 L96,3210.9985 L43,3210.9985 L43,3191.9985 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="205.218" style="stroke: #000000; stroke-width: 2.0;" width="1913" x="43" y="3191.9985"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="3206.8955">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="121" y="3205.7574">[not running]</text><polygon fill="#555555" points="86.5,3231.4105,76.5,3235.4105,86.5,3239.4105,82.5,3235.4105" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80.5" x2="660.5" y1="3235.4105" y2="3235.4105"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="261.5" y="3229.6015">{"type":"error","msg":"not running"}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="1956" y1="3244.4105" y2="3244.4105"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="48" y="3256.1694">[stop everything]</text><polygon fill="#555555" points="1857,3280.0984,1867,3284.0984,1857,3288.0984,1861,3284.0984" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="1863" y1="3284.0984" y2="3284.0984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1203.75" y="3278.2894">request_stop(); join()</text><polygon fill="#555555" points="1162.5,3311.8044,1172.5,3315.8044,1162.5,3319.8044,1166.5,3315.8044" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="1168.5" y1="3315.8044" y2="3315.8044"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="856.5" y="3309.9954">request_stop(); join()</text><polygon fill="#555555" points="936.5,3343.5104,946.5,3347.5104,936.5,3351.5104,940.5,3347.5104" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="661.5" x2="942.5" y1="3347.5104" y2="3347.5104"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="673.5" y="3341.7014">stopWriter(); resetDevices(); clearAllQueues()</text><path d="M666,3360.5104 L666,3387.5104 L907,3387.5104 L907,3370.5104 L897,3360.5104 L666,3360.5104 " fill="#F8F8F8" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M897,3360.5104 L897,3370.5104 L907,3370.5104 L897,3360.5104 " fill="#F8F8F8" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="672" y="3379.4075">wsCtx.currentMeasurement = nullptr</text><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="2524" x="3" y="3426.0695"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="3426.0695" y2="3426.0695"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="2527" y1="3429.0695" y2="3429.0695"/><rect fill="#EEEEEE" filter="url(#fyjuvjg04b1x8)" height="25.706" style="stroke: #000000; stroke-width: 2.0;" width="126" x="1202" y="3414.2165"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="1208" y="3432.1135">WebSocket close</text><polygon fill="#555555" points="456.5,3469.6285,466.5,3473.6285,456.5,3477.6285,460.5,3473.6285" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="75.5" x2="462.5" y1="3473.6285" y2="3473.6285"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="256" y="3467.8195">Close</text><polygon fill="#555555" points="649.5,3501.3345,659.5,3505.3345,649.5,3509.3345,653.5,3505.3345" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="3505.3345" y2="3505.3345"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="480.5" y="3499.5255">request_stop() (cmd worker)</text><polygon fill="#555555" points="649.5,3533.0405,659.5,3537.0405,649.5,3541.0405,653.5,3537.0405" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="655.5" y1="3537.0405" y2="3537.0405"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="485.5" y="3531.2315">enqueue(dummy) and join</text><polygon fill="#555555" points="936.5,3582.4526,946.5,3586.4526,936.5,3590.4526,940.5,3586.4526" style="stroke: #555555; stroke-width: 1.0;"/><line style="stroke: #555555; stroke-width: 1.0;" x1="468.5" x2="942.5" y1="3586.4526" y2="3586.4526"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="644.5" y="3562.9375">stopMeasurement(...)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="621.5" y="3580.6435">(resets devices, joins threads)</text><path d="M473,3599.4526 L473,3626.4526 L703,3626.4526 L703,3609.4526 L693,3599.4526 L473,3599.4526 " fill="#F8F8F8" filter="url(#fyjuvjg04b1x8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M693,3599.4526 L693,3609.4526 L703,3609.4526 L693,3599.4526 " fill="#F8F8F8" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="479" y="3618.3496">websocketConnectionActive = false</text><!--MD5=[7aba88ba816cf9e08d522b8d739a3ba3]
@startuml
title OmnAIScope DataServer - WS + SaveDeque + Recording/Save Flow

hide footbox
skinparam sequenceArrowThickness 1
skinparam sequenceMessageAlign center
skinparam ArrowColor #555
skinparam ParticipantPadding 20
skinparam BoxPadding 10
skinparam NoteBackgroundColor #f8f8f8

actor Client
participant "Crow WS Server\n(/ws)" as WS
participant "CmdWorker\n(workOnCommands)" as Cmd
participant "ControlWriter" as Ctrl
participant "Measurement" as M
participant "QueueFormatter" as QF
collections "SaveDeque\n(full-rate ring buffer)" as SD
participant "Writer" as W
participant "processDeque\n(sender)" as Sender
participant "OmniscopeSampler" as Sampler
collections "Devices" as Devices
queue "WS Queues\n(JSON/CSV/BIN)" as WSQ
database "Filesystem" as FS

== WebSocket handshake ==
Client -> WS: Open /ws
WS - -> Client: "Hello, connection to websocket established..."
note right of WS: websocketConnectionActive = true\nstart cmdWorker (std::jthread)
WS -> Cmd: start()

== START measurement ==
Client -> WS: {"type":"start","uuids":[...],"rate":int,"format":"csv/json/binary"}
WS -> Cmd: enqueue(Command)
Cmd -> Cmd: parseCommand("start")
alt already running (wsCtx.currentMeasurement != null)
  Cmd - -> Client: {"type":"error","msg":"already running"}
else start new measurement
  Cmd -> WS: clearAllQueues()
  Cmd -> M: create Measurement(uuids, rate, format, dest=WS)
  Cmd -> Sender: start processDeque(conn, Measurement)
  Cmd -> M: start Measurement::start(Ctrl) (std::jthread)

  == Measurement::start ==
  M -> Devices: searchDevices()\nselectDevices(uuids)\nStart devices
  M -> Sampler: set up sampler and begin acquisition

  loop while not stop_requested
    M -> Ctrl: printOrWriteData(self, stopToken)

    alt sampler has data
      Ctrl -> Sampler: copyOut(captureData) (until vectorSize >= threshold)
      Ctrl -> QF: new QueueFormatter(captureData, sampleQueue, SaveDeque, rate)
      QF -> SD: push(full-rate samples)\n(drop oldest if full)
      QF - -> Ctrl: sampled queue filled per rate

      alt Writer not created yet
        Ctrl -> W: new Writer(measurement, sampleQueue, SaveDeque, ...)\n(dest=WS, format)
      end

      == streaming via WS ==
      alt format == JSON
        W -> WSQ: push JSON batch
        Sender -> WSQ: pop
        Sender - -> Client: {"type":"data", ...}
      else format == CSV
        W -> WSQ: push CSV batch
        Sender -> WSQ: pop
        Sender - -> Client: CSV lines
      else format == BINARY
        W -> WSQ: push Protobuf batch
        Sender -> WSQ: pop
        Sender - -> Client: binary frame
      end
    else no data
      Ctrl - -> M: return (loop continues)
    end
  end
end

== RECORD start ==
Client -> WS: {"type":"record","set":"start","format":"csv/json"}
WS -> Cmd: enqueue(Command)
Cmd -> Cmd: parseCommand("record:start")
alt already recording (RECORDING == true)
  Cmd - -> Client: {"type":"record","status":"already-running"}
else begin recording to tmp
  Cmd -> Ctrl: startRecording(m)
  note right of Ctrl
    ensureRecordTmpPath():
    - create dir "Record" (idempotent)
    - tmp file: "Record/<timestamp>.tmp"
    m.dest=LOCALFILE, m.filePath=.tmp, RECORDING=true
  end note
  Ctrl -> W: new Writer(m, SaveDequeâ†’File, recordingMode=true)
  Ctrl - -> Client: {"type":"record","status":"started"}

  group Writer(recordingMode)
    loop while running AND RECORDING
      W -> SD: pop oldest
      W -> FS: append to "<timestamp>.tmp" (csv/json)
    end
  end
end

== RECORD stop ==
Client -> WS: {"type":"record","set":"stop"}
WS -> Cmd: enqueue(Command)
Cmd -> Cmd: parseCommand("record:stop")
alt not recording
  Cmd - -> Client: {"type":"record","status":"not-running"}
else stop and finalize
  Cmd -> Ctrl: stopRecording(conn)
  note right of Ctrl
    RECORDING=false
    delete Writer (waits for thread to finish)
    rename "<timestamp>.tmp" -> "<timestamp>.(csv/json)"
    send {"type":"file-ready","url":"/download/Record/<timestamp>.(csv/json)"} to client
  end note
  Cmd - -> Client: {"type":"record","status":"stopping"}
end

== SAVE (export full buffer) ==
Client -> WS: {"type":"save","path":"Data.csv/json","format":"csv/json"}
WS -> Cmd: enqueue(Command)
Cmd -> Cmd: parseCommand("save")
alt measurement running
  Cmd - -> Client: {"type":"error","msg":"Stop measurement before saving"}
else write entire SaveDeque to file
  Cmd -> Ctrl: saveData(wsCtx)
  Ctrl -> W: new Writer(m dest=LOCALFILE, filePath="Data.csv/json")
  loop until SaveDeque empty
    W -> SD: pop oldest
    W -> FS: append to "Data.csv/json"
  end
  Cmd -> Ctrl: stopWriter()  # delete Writer
  Cmd - -> Client: {"type":"file-ready","url":"/download/Data.csv/json"}
end

== STOP measurement ==
Client -> WS: {"type":"stop"}
WS -> Cmd: enqueue(Command)
Cmd -> Cmd: parseCommand("stop")
alt not running
  Cmd - -> Client: {"type":"error","msg":"not running"}
else stop everything
  Cmd -> Sender: request_stop(); join()
  Cmd -> M: request_stop(); join()
  Cmd -> Ctrl: stopWriter(); resetDevices(); clearAllQueues()
  note right of Cmd: wsCtx.currentMeasurement = nullptr
end

== WebSocket close ==
Client -> WS: Close
WS -> Cmd: request_stop() (cmd worker)
WS -> Cmd: enqueue(dummy) and join
WS -> Ctrl: stopMeasurement(...)\n(resets devices, joins threads)
note right of WS: websocketConnectionActive = false

@enduml

PlantUML version 1.2020.02(Sun Mar 01 11:22:07 CET 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.16+8-Ubuntu-0ubuntu124.04.1
Operating System: Linux
Default Encoding: UTF-8
Language: de
Country: DE
--></g></svg>